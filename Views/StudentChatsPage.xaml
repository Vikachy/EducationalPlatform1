<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="EducationalPlatform.Views.StudentChatsPage"
             Title="ÐœÐ¾Ð¸ Ñ‡Ð°Ñ‚Ñ‹"
             xmlns:converters="clr-namespace:EducationalPlatform.Converters"
             xmlns:models="clr-namespace:EducationalPlatform.Models"
             BackgroundColor="{DynamicResource BackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:FileTypeToIconConverter x:Key="FileTypeToIconConverter" />
            <converters:ChatTypeToColorConverter x:Key="ChatTypeToColorConverter" />
            <converters:ChatTypeToIconConverter x:Key="ChatTypeToIconConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº -->
        <Border Grid.Row="0" BackgroundColor="#2E86AB" Padding="15">
            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                <Label Grid.Column="0" Text="ðŸ’¬ Ð’ÑÐµ Ð¼Ð¾Ð¸ Ñ‡Ð°Ñ‚Ñ‹" FontSize="18" FontAttributes="Bold" TextColor="White" />
                <Button Grid.Column="1" Text="ðŸ“š ÐšÑƒÑ€ÑÑ‹" BackgroundColor="White" TextColor="#2E86AB" CornerRadius="8" Padding="10,6" Clicked="OnMyCoursesClicked" />
            </Grid>
        </Border>

        <!-- ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ñ Ð´Ð²ÑƒÐ¼Ñ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ð¼Ð¸ -->
        <Grid Grid.Row="1" ColumnDefinitions="350,*">
            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² ÑÐ»ÐµÐ²Ð° -->
            <CollectionView Grid.Column="0"
                            x:Name="AllChatsCollectionView"
                            ItemsSource="{Binding AllChats}"
                            SelectionMode="Single"
                            SelectionChanged="OnChatSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="10,5" BackgroundColor="White" Padding="15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Frame Grid.Column="0" BackgroundColor="{Binding ChatType, Converter={StaticResource ChatTypeToColorConverter}}"
                                   CornerRadius="20" HeightRequest="40" WidthRequest="40" Padding="0" VerticalOptions="Center">
                                <Label Text="{Binding ChatType, Converter={StaticResource ChatTypeToIconConverter}}"
                                       FontSize="16" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" />
                            </Frame>

                            <VerticalStackLayout Grid.Column="1" Margin="10,0" Spacing="4">
                                <Label Text="{Binding ChatName}" FontSize="16" FontAttributes="Bold" LineBreakMode="TailTruncation" />
                                <Label Text="{Binding Description}" FontSize="12" TextColor="#666" LineBreakMode="TailTruncation" />
                                <Label Text="{Binding LastMessage}" FontSize="11" TextColor="#888" MaxLines="1" LineBreakMode="TailTruncation" />
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2" HorizontalOptions="End" Spacing="4">
                                <Label Text="{Binding LastMessageTime, StringFormat='{0:HH:mm}'}"
                                       FontSize="10" TextColor="Gray" />

                                <Frame IsVisible="{Binding UnreadMessages, Converter={StaticResource GreaterThanZeroConverter}}"
                                       BackgroundColor="Red" CornerRadius="10" Padding="6,2" HorizontalOptions="End">
                                    <Label Text="{Binding UnreadMessages}" FontSize="10" TextColor="White" FontAttributes="Bold" />
                                </Frame>
                            </VerticalStackLayout>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ñ‡Ð°Ñ‚Ð° ÑÐ¿Ñ€Ð°Ð²Ð° -->
            <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto" IsVisible="{Binding HasActiveChat}">
                <Border Grid.Row="0" BackgroundColor="#2E86AB" Padding="15">
                    <VerticalStackLayout>
                        <Label x:Name="ChatTitleLabel" Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚" FontSize="18"
                               FontAttributes="Bold" TextColor="White" HorizontalOptions="Center" />
                        <Label x:Name="ChatSubtitleLabel" Text="ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ" FontSize="12" TextColor="White" HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Border>

                <CollectionView Grid.Row="1"
                                x:Name="MessagesCollectionView"
                                ItemsSource="{Binding Messages}"
                                SelectionMode="None"
                                EmptyView="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:ChatMessage">
                            <Grid Padding="10,5" ColumnDefinitions="*,*">
                                <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ -->
                                <Frame Grid.Column="0" Grid.ColumnSpan="2"
                                       IsVisible="{Binding IsMyMessage, Converter={StaticResource InverseBoolConverter}}"
                                       BackgroundColor="#FFFFFF"
                                       Padding="12"
                                       HorizontalOptions="Start"
                                       MaximumWidthRequest="300"
                                       CornerRadius="18"
                                       BorderColor="#E0E0E0">
                                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="4">
                                        <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                                                BackgroundColor="LightGray" Stroke="LightGray" StrokeThickness="1"
                                                StrokeShape="RoundRectangle 20" WidthRequest="36" HeightRequest="36"
                                                VerticalOptions="Start">
                                            <Image Source="{Binding SenderAvatar}" Aspect="AspectFill"
                                                   HorizontalOptions="Center" VerticalOptions="Center"
                                                   WidthRequest="32" HeightRequest="32" />
                                        </Border>
                                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding SenderName}" FontSize="12" TextColor="#2E86AB" FontAttributes="Bold" VerticalOptions="End" />
                                        <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="4">
                                            <Label Text="{Binding MessageText}" TextColor="#333333" FontSize="14" LineBreakMode="WordWrap" IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />
                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" IsVisible="{Binding IsFileMessage}">
                                                <Label Grid.Column="0" Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}" FontSize="16" VerticalOptions="Center" />
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="{Binding FileName}" FontSize="13" FontAttributes="Bold" LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding FileSize}" FontSize="11" TextColor="Gray" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>
                                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding SentAt, StringFormat='{0:HH:mm}'}" FontSize="10" TextColor="Gray" HorizontalOptions="End" VerticalOptions="End" />
                                    </Grid>
                                </Frame>

                                <!-- ÐœÐ¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ -->
                                <Frame Grid.Column="1" Grid.ColumnSpan="2"
                                       IsVisible="{Binding IsMyMessage}"
                                       BackgroundColor="#DCF8C6"
                                       Padding="12"
                                       HorizontalOptions="End"
                                       MaximumWidthRequest="300"
                                       CornerRadius="18">
                                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="4">
                                        <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                            <Label Text="{Binding MessageText}" TextColor="#000000" FontSize="14" LineBreakMode="WordWrap" IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />
                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8" IsVisible="{Binding IsFileMessage}">
                                                <Label Grid.Column="0" Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}" FontSize="16" VerticalOptions="Center" />
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="{Binding FileName}" FontSize="13" FontAttributes="Bold" LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding FileSize}" FontSize="11" TextColor="#666666" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>
                                        <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" HorizontalOptions="End" Spacing="4" VerticalOptions="End">
                                            <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}" FontSize="10" TextColor="#666666" />
                                            <Label Text="âœ“âœ“" FontSize="10" TextColor="#34B7F1" IsVisible="{Binding IsDelivered}" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Frame>

                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
                <Border Grid.Row="2" BackgroundColor="White" Stroke="#E0E0E0" StrokeThickness="1" Padding="10">
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                        <Entry Grid.Column="0" x:Name="MessageEntry" Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." Completed="OnMessageSent" ReturnType="Send" />
                        <Button Grid.Column="1" Text="ðŸ“Ž" BackgroundColor="Transparent" TextColor="#2E86AB" WidthRequest="40" HeightRequest="40" Clicked="OnAttachFileClicked" />
                        <Button Grid.Column="2" Text="âž¤" BackgroundColor="#2E86AB" TextColor="White" WidthRequest="40" HeightRequest="40" Clicked="OnSendMessageClicked" />
                    </Grid>
                </Border>
            </Grid>

            <!-- Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° -->
            <VerticalStackLayout Grid.Column="1" IsVisible="{Binding HasActiveChat, Converter={StaticResource InverseBoolConverter}}" HorizontalOptions="Center" VerticalOptions="Center" Spacing="20">
                <Label Text="ðŸ’¬" FontSize="80" HorizontalOptions="Center" />
                <Label Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ" FontSize="18" HorizontalOptions="Center" TextColor="Gray" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
