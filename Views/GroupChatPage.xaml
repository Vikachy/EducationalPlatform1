<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="EducationalPlatform.Views.GroupChatPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:EducationalPlatform.Converters"
             Title="Ð§Ð°Ñ‚ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:FileTypeToIconConverter x:Key="FileTypeToIconConverter" />
            <converters:NotNullConverter x:Key="NotNullConverter" />
            <converters:AvatarToImageSourceConverter x:Key="AvatarConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header ÐºÐ°Ðº Ð² Telegram -->
        <Border Grid.Row="0" 
                BackgroundColor="#2E86AB"
                StrokeThickness="0"
                Padding="10">
            <Grid ColumnDefinitions="Auto,*,Auto" 
                  VerticalOptions="Center"
                  HeightRequest="50">

                <Button Grid.Column="0" 
                        Text="â†" 
                        Clicked="OnBackClicked"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        FontSize="18"
                        WidthRequest="40"
                        HeightRequest="40"/>

                <VerticalStackLayout Grid.Column="1" 
                                   Spacing="2"
                                   HorizontalOptions="Start">
                    <Label Text="{Binding Title}"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="White" />
                    <Label Text="Ð¾Ð½Ð»Ð°Ð¹Ð½"
                           FontSize="12"
                           TextColor="LightGray" />
                </VerticalStackLayout>

                <Button Grid.Column="2" 
                        Text="ðŸ‘¥"
                        Clicked="OnMembersClicked"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        FontSize="16"
                        WidthRequest="40"
                        HeightRequest="40"/>
            </Grid>
        </Border>

        <!-- Messages -->
        <Grid Grid.Row="1">
            <ActivityIndicator x:Name="LoadingIndicator"
                              IsVisible="False"
                              IsRunning="False"
                              Color="{DynamicResource PrimaryColor}"
                              VerticalOptions="Center"
                              HorizontalOptions="Center" />
            
            <ScrollView>
                <CollectionView x:Name="MessagesCollectionView"
                                ItemsSource="{Binding Messages}"
                                SelectionMode="None"
                                VerticalScrollBarVisibility="Always">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="10,5"
                          ColumnDefinitions="Auto,*,Auto">

                        <!-- Other user's message -->
                        <Frame Grid.Column="0"
                               Grid.ColumnSpan="2"
                               IsVisible="{Binding IsMyMessage, Converter={StaticResource InverseBoolConverter}}"
                               BackgroundColor="#FFFFFF"
                               Padding="12"
                               HorizontalOptions="Start"
                               MaximumWidthRequest="{OnPlatform WinUI=400, Default=280}"
                               HasShadow="False"
                               CornerRadius="18"
                               BorderColor="#E0E0E0">
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" 
                                  ColumnSpacing="8" RowSpacing="4">

                                <!-- Avatar -->
                                <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                                        BackgroundColor="LightGray"
                                        Stroke="LightGray"
                                        StrokeThickness="1"
                                        StrokeShape="RoundRectangle 20"
                                        WidthRequest="36"
                                        HeightRequest="36"
                                        VerticalOptions="Start">
                                    <Image Source="{Binding SenderAvatar, Converter={StaticResource AvatarConverter}}"
                                           Aspect="AspectFill"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           WidthRequest="32"
                                           HeightRequest="32" />
                                </Border>

                                <!-- Sender Name with Emoji -->
                                <HorizontalStackLayout Grid.Row="0" Grid.Column="1"
                                                       Spacing="4"
                                                       VerticalOptions="End">
                                    <Label Text="{Binding SenderName}"
                                           FontSize="12"
                                           TextColor="#2E86AB"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding UserEmoji}"
                                           FontSize="14"
                                           IsVisible="{Binding UserEmoji, Converter={StaticResource NotNullConverter}}"
                                           VerticalOptions="Center" />
                                </HorizontalStackLayout>

                                <!-- Message Text or File -->
                                <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="4">
                                    <!-- Text Message -->
                                    <Label Text="{Binding MessageText}"
                                           TextColor="{DynamicResource TextColor}"
                                           FontSize="14"
                                           LineBreakMode="WordWrap"
                                           IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />

                                    <!-- File Message -->
                                    <Border BackgroundColor="#E8F4F8"
                                            Stroke="#2E86AB"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 8"
                                            Padding="10"
                                            IsVisible="{Binding IsFileMessage}">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnFileMessageTapped" CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="Auto,*" 
                                              ColumnSpacing="8">
                                            <Label Grid.Column="0"
                                                   Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}"
                                                   FontSize="20"
                                                   VerticalOptions="Center" />
                                            <VerticalStackLayout Grid.Column="1">
                                                <Label Text="{Binding FileName}"
                                                       FontSize="13"
                                                       FontAttributes="Bold"
                                                       LineBreakMode="TailTruncation"
                                                       TextColor="#2E86AB" />
                                                <Label Text="{Binding FileSize}"
                                                       FontSize="11"
                                                       TextColor="Gray" />
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>
                                </VerticalStackLayout>

                                <!-- Time -->
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding SentDate, StringFormat='{0:HH:mm}'}"
                                       FontSize="10"
                                       TextColor="Gray"
                                       HorizontalOptions="End"
                                       VerticalOptions="End" />
                            </Grid>
                        </Frame>

                        <!-- My message -->
                        <Frame Grid.Column="1"
                               Grid.ColumnSpan="2"
                               IsVisible="{Binding IsMyMessage}"
                               BackgroundColor="#DCF8C6"
                               Padding="12"
                               HorizontalOptions="End"
                               MaximumWidthRequest="{OnPlatform WinUI=400, Default=280}"
                               HasShadow="False"
                               CornerRadius="18">
                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto"
                                  RowSpacing="4">

                                <!-- Message Text or File -->
                                <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                    <!-- Text Message -->
                                    <Label Text="{Binding MessageText}"
                                           TextColor="#000000"
                                           FontSize="14"
                                           LineBreakMode="WordWrap"
                                           IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />

                                    <!-- File Message -->
                                    <Border BackgroundColor="#E8F4F8"
                                            Stroke="#2E86AB"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 8"
                                            Padding="10"
                                            IsVisible="{Binding IsFileMessage}">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnFileMessageTapped" CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="Auto,*" 
                                              ColumnSpacing="8">
                                            <Label Grid.Column="0"
                                                   Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}"
                                                   FontSize="20"
                                                   VerticalOptions="Center" />
                                            <VerticalStackLayout Grid.Column="1">
                                                <Label Text="{Binding FileName}"
                                                       FontSize="13"
                                                       FontAttributes="Bold"
                                                       LineBreakMode="TailTruncation"
                                                       TextColor="#2E86AB" />
                                                <Label Text="{Binding FileSize}"
                                                       FontSize="11"
                                                       TextColor="#666666" />
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>
                                </VerticalStackLayout>

                                <!-- Time and Status -->
                                <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                      HorizontalOptions="End"
                                                      Spacing="4"
                                                      VerticalOptions="End">
                                    <Label Text="{Binding SentDate, StringFormat='{0:HH:mm}'}"
                                           FontSize="10"
                                           TextColor="#666666" />
                                    <Label Text="âœ“âœ“"
                                           FontSize="10"
                                           TextColor="#34B7F1"
                                           IsVisible="{Binding IsDelivered}" />
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            </CollectionView>
            </ScrollView>
        </Grid>

        <!-- Message Input ÐºÐ°Ðº Ð² Telegram -->
        <Border Grid.Row="2"
                BackgroundColor="White"
                Stroke="#E0E0E0"
                StrokeThickness="1"
                Padding="10">
            <Grid ColumnDefinitions="*,Auto,Auto" 
                  ColumnSpacing="8"
                  VerticalOptions="Center">

                <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° -->
                <Frame Grid.Column="0"
                       BackgroundColor="#F1F1F1"
                       Padding="12"
                       HasShadow="False"
                       CornerRadius="20">
                    <Entry x:Name="MessageEntry"
                           Placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                           Completed="OnMessageSent"
                           BackgroundColor="Transparent" />
                </Frame>

                <Button Grid.Column="1"
                        Text="ðŸ“Ž"
                        Clicked="OnAttachFileClicked"
                        BackgroundColor="Transparent"
                        TextColor="#2E86AB"
                        MinimumWidthRequest="44"
                        MinimumHeightRequest="44"
                        WidthRequest="44"
                        HeightRequest="44"
                        FontSize="16" />

                <Button Grid.Column="2"
                        Text="âž¤"
                        Clicked="OnSendMessageClicked"
                        BackgroundColor="#2E86AB"
                        TextColor="White"
                        MinimumWidthRequest="44"
                        MinimumHeightRequest="44"
                        WidthRequest="44"
                        HeightRequest="44"
                        CornerRadius="22"
                        FontSize="16"
                        FontAttributes="Bold" />
            </Grid>
        </Border>

    </Grid>
</ContentPage>