<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:EducationalPlatform.Converters"
             x:Class="EducationalPlatform.Views.TeacherChatsPage"
             Title="Ð§Ð°Ñ‚Ñ‹ Ð³Ñ€ÑƒÐ¿Ð¿">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:MyMessageColorConverter x:Key="MyMessageColorConverter" />
            <converters:MessageAlignmentConverter x:Key="MessageAlignmentConverter" />
            <converters:BoolInverseConverter x:Key="BoolInverseConverter" />
            <converters:IntToBoolConverter x:Key="IntToBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- ÐÐ´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼Ð°ÐºÐµÑ‚: Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… - Ð¾Ð´Ð½Ð° ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°, Ð½Ð° Ð´ÐµÑÐºÑ‚Ð¾Ð¿Ðµ - Ð´Ð²Ðµ -->
    <Grid x:Name="MainGrid"
          ColumnDefinitions="{OnIdiom Default='*', Desktop='300,*'}">
        
        <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° Ð²ÐµÑÑŒ ÑÐºÑ€Ð°Ð½ -->
        <Grid x:Name="LoadingOverlay"
              Grid.ColumnSpan="2"
              BackgroundColor="#80000000"
              IsVisible="False"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">
            <VerticalStackLayout 
                Spacing="20"
                VerticalOptions="Center"
                HorizontalOptions="Center">
                <ActivityIndicator x:Name="LoadingIndicator"
                                   IsRunning="False"
                                   Color="White"
                                   HeightRequest="50"
                                   WidthRequest="50"/>
                <Label Text="Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‡Ð°Ñ‚Ð¾Ð²..."
                       TextColor="White"
                       FontSize="16"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>

        <!-- Ð›ÐµÐ²Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ - ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ¿Ð¿ -->
        <Grid Grid.Column="0" RowDefinitions="Auto,*,Auto">

            <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº -->
            <Border Grid.Row="0" BackgroundColor="#2E86AB" Padding="15">
                <Label Text="ÐœÐ¾Ð¸ ÑƒÑ‡ÐµÐ±Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹" 
                       FontSize="16" 
                       FontAttributes="Bold" 
                       TextColor="White" 
                       HorizontalOptions="Center" />
            </Border>

            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ¿Ð¿ -->
            <CollectionView Grid.Row="1" x:Name="GroupsCollectionView"
                            SelectionMode="Single"
                            SelectionChanged="OnGroupSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="10" 
                              BackgroundColor="White"
                              Margin="5">

                            <Frame BackgroundColor="#F8F9FA" 
                                   BorderColor="#E9ECEF"
                                   CornerRadius="10"
                                   Padding="15"
                                   HasShadow="True">

                                <Grid ColumnDefinitions="Auto,*,Auto" 
                                      RowDefinitions="Auto,Auto,Auto">

                                    <!-- Ð˜ÐºÐ¾Ð½ÐºÐ° Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ -->
                                    <Label Grid.Row="0" Grid.Column="0" 
                                           Grid.RowSpan="3"
                                           Text="ðŸ‘¥" 
                                           FontSize="20" 
                                           VerticalOptions="Center" 
                                           Margin="0,0,10,0" />

                                    <!-- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð¸ ÐºÑƒÑ€ÑÐ° -->
                                    <Label Grid.Row="0" Grid.Column="1"
                                           Text="{Binding GroupName}" 
                                           FontSize="14" 
                                           FontAttributes="Bold" />

                                    <Label Grid.Row="1" Grid.Column="1"
                                           Text="{Binding CourseName}" 
                                           FontSize="12" 
                                           TextColor="#666" />

                                    <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¸ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ‹ -->
                                    <Label Grid.Row="2" Grid.Column="1"
                                           Text="{Binding StudentCount, StringFormat='{0} ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð²'}" 
                                           FontSize="11" 
                                           TextColor="#999" />

                                    <!-- Ð‘ÐµÐ¹Ð´Ð¶ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
                                    <Frame Grid.Row="0" Grid.Column="2"
                                           Grid.RowSpan="3"
                                           BackgroundColor="#FF3B30"
                                           Padding="6,2"
                                           HorizontalOptions="End"
                                           VerticalOptions="Start"
                                           CornerRadius="10"
                                           IsVisible="{Binding UnreadMessages, Converter={x:StaticResource IntToBoolConverter}}">
                                        <Label Text="{Binding UnreadMessages}" 
                                               FontSize="10" 
                                               FontAttributes="Bold" 
                                               TextColor="White" 
                                               HorizontalOptions="Center" 
                                               VerticalOptions="Center"/>
                                    </Frame>

                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼Ð¸ -->
            <Button Grid.Row="2"
                    Text="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼Ð¸" 
                    Clicked="OnManageGroupsClicked"
                    BackgroundColor="#2E86AB"
                    TextColor="White"
                    Margin="10"
                    CornerRadius="10" />

        </Grid>

        <!-- ÐŸÑ€Ð°Ð²Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ - Ñ‡Ð°Ñ‚ (ÑÐºÑ€Ñ‹Ñ‚Ð° Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ…, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸ÑŽ) -->
        <Grid Grid.Column="1" 
              BackgroundColor="#F5F5F5"
              IsVisible="{OnIdiom Default=False, Desktop=True}"
              x:Name="ChatPanel">

            <Grid RowDefinitions="Auto,*,Auto" 
                  ColumnDefinitions="*">

                <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ‡Ð°Ñ‚Ð° -->
                <Border Grid.Row="0" 
                        BackgroundColor="White" 
                        Stroke="LightGray" 
                        StrokeThickness="1"
                        StrokeShape="Rectangle"
                        Padding="15">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Grid.Column="0">
                            <Label x:Name="ChatGroupNameLabel" 
                                   Text="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹" 
                                   FontSize="16" 
                                   FontAttributes="Bold" />
                            <Label x:Name="ChatOnlineLabel" 
                                   Text="Online: 0" 
                                   FontSize="12" 
                                   TextColor="Gray" />
                        </VerticalStackLayout>

                        <Button Grid.Column="1"
                                Text="ÐÐ°Ð·Ð°Ð´" 
                                Clicked="OnBackClicked"
                                BackgroundColor="Transparent"
                                TextColor="#2E86AB"
                                BorderColor="#2E86AB"
                                BorderWidth="1"
                                CornerRadius="5"
                                Padding="10,5" />
                    </Grid>
                </Border>

                <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                <CollectionView Grid.Row="1" 
                                x:Name="MessagesCollectionView"
                                Margin="10">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="5">

                                <!-- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ -->
                                <Frame BackgroundColor="#E3F2FD"
                                        Padding="10"
                                        HorizontalOptions="Center"
                                        CornerRadius="15"
                                        IsVisible="{Binding IsSystemMessage}">
                                    <Label Text="{Binding MessageText}" 
                                           FontSize="12"
                                           TextColor="#1565C0"
                                           HorizontalOptions="Center" />
                                </Frame>

                                <!-- Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ -->
                                <Frame BackgroundColor="{Binding IsMyMessage, Converter={x:StaticResource MyMessageColorConverter}}"
                                        Padding="15"
                                        HorizontalOptions="{Binding IsMyMessage, Converter={x:StaticResource MessageAlignmentConverter}}"
                                        CornerRadius="15"
                                        IsVisible="{Binding IsFileMessage}">
                                    <Grid ColumnDefinitions="Auto,*" 
                                          RowDefinitions="Auto,Auto">
                                        <Label Grid.Row="0" Grid.Column="0"
                                               Text="ðŸ“Ž" 
                                               FontSize="16"
                                               VerticalOptions="Center"
                                               Margin="0,0,10,0" />
                                        <Label Grid.Row="0" Grid.Column="1"
                                               Text="{Binding FileName}" 
                                               FontSize="14"
                                               FontAttributes="Bold" />
                                        <Label Grid.Row="1" Grid.Column="1"
                                               Text="{Binding FileSize}" 
                                               FontSize="12"
                                               TextColor="#666" />
                                    </Grid>
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Tapped="OnFileMessageTapped"
                                            CommandParameter="{Binding .}" />
                                    </Frame.GestureRecognizers>
                                </Frame>

                                <!-- ÐžÐ±Ñ‹Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ -->
                                <Frame BackgroundColor="{Binding IsMyMessage, Converter={x:StaticResource MyMessageColorConverter}}"
                                        Padding="15"
                                        HorizontalOptions="{Binding IsMyMessage, Converter={x:StaticResource MessageAlignmentConverter}}"
                                        CornerRadius="15"
                                        IsVisible="{Binding IsFileMessage, Converter={x:StaticResource BoolInverseConverter}}">
                                    <VerticalStackLayout>
                                        <Label Text="{Binding MessageText}" 
                                               FontSize="14" />
                                        <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}" 
                                               FontSize="10" 
                                               TextColor="#666"
                                               HorizontalOptions="End" />
                                    </VerticalStackLayout>
                                </Frame>

                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð²Ð²Ð¾Ð´Ð° -->
                <Grid Grid.Row="2" 
                      BackgroundColor="White" 
                      Padding="10"
                      ColumnDefinitions="*,Auto,Auto">

                    <Entry Grid.Column="0"
                           x:Name="MessageEntry"
                           Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                           Completed="OnMessageSent"
                           Margin="0,0,10,0" />

                    <Button Grid.Column="1"
                            Text="ðŸ“Ž"
                            Clicked="OnAttachFileClicked"
                            BackgroundColor="Transparent"
                            TextColor="#2E86AB"
                            MinimumWidthRequest="44"
                            MinimumHeightRequest="44"
                            Margin="0,0,10,0" />

                    <Button Grid.Column="2"
                            Text="ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ"
                            Clicked="OnSendMessageClicked"
                            BackgroundColor="#2E86AB"
                            TextColor="White"
                            MinimumWidthRequest="44"
                            MinimumHeightRequest="44" />

                </Grid>

            </Grid>

            <!-- Ð—Ð°Ð³Ð»ÑƒÑˆÐºÐ° ÐºÐ¾Ð³Ð´Ð° Ñ‡Ð°Ñ‚ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½ -->
            <VerticalStackLayout HorizontalOptions="Center" 
                                 VerticalOptions="Center"
                                 IsVisible="{OnIdiom Default=True, Desktop=False}">
                <Label Text="ðŸ’¬" 
                       FontSize="40" 
                       HorizontalOptions="Center" />
                <Label Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð´Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ" 
                       FontSize="16" 
                       TextColor="Gray" 
                       HorizontalOptions="Center" />
            </VerticalStackLayout>

        </Grid>

    </Grid>
</ContentPage>