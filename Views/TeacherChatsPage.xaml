<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="EducationalPlatform.Views.TeacherChatsPage"
             Title="Teacher Chats"
             xmlns:converters="clr-namespace:EducationalPlatform.Converters"
             xmlns:models="clr-namespace:EducationalPlatform.Models">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StatusTextConverter x:Key="StatusConverter" />
            <converters:StatusColorConverter x:Key="StatusColorConverter" />
            <converters:FileTypeToIconConverter x:Key="FileTypeToIconConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:GreaterThanZeroConverter x:Key="GreaterThanZeroConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº -->
        <Border Grid.Row="0" BackgroundColor="#2E86AB" Padding="15">
            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                <Label Grid.Column="0" Text="ðŸ’¬ Group Chat Management" FontSize="18" FontAttributes="Bold" TextColor="White" />
                <Button Grid.Column="1" Text="ðŸ‘¥ Groups" BackgroundColor="White" TextColor="#2E86AB" CornerRadius="8" Padding="10,6" Clicked="OnManageGroupsClicked" />
            </Grid>
        </Border>

        <!-- Ð”Ð²Ðµ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸: ÑÐ»ÐµÐ²Ð° ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð², ÑÐ¿Ñ€Ð°Ð²Ð° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ‡Ð°Ñ‚ -->
        <Grid Grid.Row="1" ColumnDefinitions="300,*">
            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ¿Ð¿ ÑÐ»ÐµÐ²Ð° -->
            <CollectionView Grid.Column="0" 
                            x:Name="GroupsCollectionView"
                            ItemsSource="{Binding Groups}"
                            SelectionMode="Single"
                            SelectionChanged="OnGroupSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="10,5" 
                                BackgroundColor="White" 
                                Stroke="#E0E0E0" 
                                StrokeThickness="1" 
                                StrokeShape="RoundRectangle 10" 
                                Padding="15">
                            <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                                <Label Grid.Column="0" Text="ðŸ‘¥" FontSize="24" VerticalOptions="Center" Margin="0,0,10,0" />
                                <VerticalStackLayout Grid.Column="1" Spacing="5">
                                    <Label Text="{Binding GroupName}" FontSize="16" FontAttributes="Bold" />
                                    <Label Text="{Binding CourseName}" FontSize="12" TextColor="#666" />
                                    <Label Text="{Binding StudentCount, StringFormat='Students: {0}'}" FontSize="10" TextColor="#999" />
                                    <Label Text="{Binding IsActive, Converter={StaticResource StatusConverter}}" FontSize="10" TextColor="{Binding IsActive, Converter={StaticResource StatusColorConverter}}" />
                                </VerticalStackLayout>
                                <Grid Grid.Column="2" HorizontalOptions="End">
                                    <Button Text="ðŸ’¬" BackgroundColor="#2E86AB" TextColor="White" WidthRequest="40" HeightRequest="40" CornerRadius="20" />
                                    <!-- Ð‘ÐµÐ¹Ð´Ð¶ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
                                    <Frame IsVisible="{Binding UnreadMessages, Converter={StaticResource GreaterThanZeroConverter}}"
                                           BackgroundColor="Red" 
                                           CornerRadius="10" 
                                           Padding="6,2" 
                                           HorizontalOptions="Start" 
                                           VerticalOptions="Start"
                                           Margin="-5, -5, 0, 0">
                                        <Label Text="{Binding UnreadMessages}" 
                                               FontSize="10" 
                                               TextColor="White" 
                                               FontAttributes="Bold" />
                                    </Frame>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- ÐŸÑ€Ð°Ð²Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ: Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ‡Ð°Ñ‚ ÐºÐ°Ðº Ð² Telegram -->
            <Grid Grid.Column="1" RowDefinitions="Auto,*,Auto">
                <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ‡Ð°Ñ‚Ð° -->
                <Border Grid.Row="0" BackgroundColor="#2E86AB" Padding="15">
                    <VerticalStackLayout>
                        <Label x:Name="ChatGroupNameLabel" Text="Select a chat" FontSize="18" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center" />
                        <Label x:Name="ChatOnlineLabel" Text="Online: 0" FontSize="12" TextColor="White" HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Border>

                <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                <CollectionView Grid.Row="1"
                                x:Name="MessagesCollectionView"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:GroupChatMessage">
                            <Grid Padding="10,5" ColumnDefinitions="*,*">
                                <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð° -->
                                <Frame Grid.Column="0" Grid.ColumnSpan="2"
                                       IsVisible="{Binding IsMyMessage, Converter={StaticResource InverseBoolConverter}}"
                                       BackgroundColor="#FFFFFF"
                                       Padding="12"
                                       HorizontalOptions="Start"
                                       MaximumWidthRequest="300"
                                       CornerRadius="18"
                                       BorderColor="#E0E0E0">
                                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="4">
                                        <!-- Avatar -->
                                        <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                                                BackgroundColor="LightGray"
                                                Stroke="LightGray"
                                                StrokeThickness="1"
                                                StrokeShape="RoundRectangle 20"
                                                WidthRequest="36"
                                                HeightRequest="36"
                                                VerticalOptions="Start">
                                            <Image Source="{Binding SenderAvatar}"
                                                   Aspect="AspectFill"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   WidthRequest="32"
                                                   HeightRequest="32" />
                                        </Border>

                                        <!-- Sender Name -->
                                        <Label Grid.Row="0" Grid.Column="1"
                                               Text="{Binding SenderName}"
                                               FontSize="12"
                                               TextColor="#2E86AB"
                                               FontAttributes="Bold"
                                               VerticalOptions="End" />

                                        <!-- Message Content -->
                                        <VerticalStackLayout Grid.Row="1" Grid.Column="1" Spacing="4">
                                            <!-- Text Message -->
                                            <Label Text="{Binding MessageText}"
                                                   TextColor="#333333"
                                                   FontSize="14"
                                                   LineBreakMode="WordWrap"
                                                   IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />

                                            <!-- File Message -->
                                            <Grid ColumnDefinitions="Auto,*" 
                                                  ColumnSpacing="8"
                                                  IsVisible="{Binding IsFileMessage}">
                                                <Label Grid.Column="0"
                                                       Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}"
                                                       FontSize="16"
                                                       VerticalOptions="Center" />
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="{Binding FileName}"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding FileSize}"
                                                           FontSize="11"
                                                           TextColor="Gray" />
                                                </VerticalStackLayout>
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnFileMessageTapped" CommandParameter="{Binding .}" />
                                                </Grid.GestureRecognizers>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- Time -->
                                        <Label Grid.Row="1" Grid.Column="1"
                                               Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                               FontSize="10"
                                               TextColor="Gray"
                                               HorizontalOptions="End"
                                               VerticalOptions="End" />
                                    </Grid>
                                </Frame>

                                <!-- ÐœÐ¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ (Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ) -->
                                <Frame Grid.Column="1" Grid.ColumnSpan="2"
                                       IsVisible="{Binding IsMyMessage}"
                                       BackgroundColor="#DCF8C6"
                                       Padding="12"
                                       HorizontalOptions="End"
                                       MaximumWidthRequest="300"
                                       CornerRadius="18">
                                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="4">
                                        <!-- Message Content -->
                                        <VerticalStackLayout Grid.Row="0" Grid.Column="0" Spacing="4">
                                            <!-- Text Message -->
                                            <Label Text="{Binding MessageText}"
                                                   TextColor="#000000"
                                                   FontSize="14"
                                                   LineBreakMode="WordWrap"
                                                   IsVisible="{Binding IsFileMessage, Converter={StaticResource InverseBoolConverter}}" />

                                            <!-- File Message -->
                                            <Grid ColumnDefinitions="Auto,*" 
                                                  ColumnSpacing="8"
                                                  IsVisible="{Binding IsFileMessage}">
                                                <Label Grid.Column="0"
                                                       Text="{Binding FileType, Converter={StaticResource FileTypeToIconConverter}}"
                                                       FontSize="16"
                                                       VerticalOptions="Center" />
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="{Binding FileName}"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           LineBreakMode="TailTruncation" />
                                                    <Label Text="{Binding FileSize}"
                                                           FontSize="11"
                                                           TextColor="#666666" />
                                                </VerticalStackLayout>
                                                <Grid.GestureRecognizers>
                                                    <TapGestureRecognizer Tapped="OnFileMessageTapped" CommandParameter="{Binding .}" />
                                                </Grid.GestureRecognizers>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- Time and Status -->
                                        <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                              HorizontalOptions="End"
                                                              Spacing="4"
                                                              VerticalOptions="End">
                                            <Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                                   FontSize="10"
                                                   TextColor="#666666" />
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Frame>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Ð’Ð²Ð¾Ð´ -->
                <Border Grid.Row="2" BackgroundColor="White" Stroke="#E0E0E0" StrokeThickness="1" Padding="10">
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                        <Entry Grid.Column="0" x:Name="MessageEntry" Placeholder="Type a message..." Completed="OnMessageSent" ReturnType="Send" />
                        <Button Grid.Column="1" Text="ðŸ“Ž" BackgroundColor="Transparent" TextColor="#2E86AB" WidthRequest="40" HeightRequest="40" Clicked="OnAttachFileClicked" />
                        <Button Grid.Column="2" Text="âž¤" BackgroundColor="#2E86AB" TextColor="White" WidthRequest="40" HeightRequest="40" Clicked="OnSendMessageClicked" />
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>