<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="EducationalPlatform.Views.ChatPage"
    Title="Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚"
    xmlns:converters="clr-namespace:EducationalPlatform.Converters"
    BackgroundColor="{DynamicResource BackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            <converters:BoolToTextColorConverter x:Key="BoolToTextColorConverter" />
            <converters:BoolToTimeColorConverter x:Key="BoolToTimeColorConverter" />
            <converters:FileTypeToIconConverter x:Key="FileTypeToIconConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ‡Ð°Ñ‚Ð° -->
        <Border Grid.Row="0" 
                BackgroundColor="#2E86AB" 
                Padding="15">
            <VerticalStackLayout>
                <Label Text="{Binding GroupName}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White"
                       HorizontalOptions="Center" />

                <Label Text="{Binding OnlineCount, StringFormat='ÐžÐ½Ð»Ð°Ð¹Ð½: {0}'}"
                       FontSize="12"
                       TextColor="White"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Border>

        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ -->
        <CollectionView Grid.Row="1"
                        x:Name="MessagesCollectionView"
                        ItemsSource="{Binding Messages}"
                        SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="10,5" ColumnDefinitions="*,*">
                        <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ -->
                        <Frame Grid.Column="0" Grid.ColumnSpan="2"
                               IsVisible="{Binding IsMyMessage, Converter={StaticResource InverseBoolConverter}}"
                               BackgroundColor="#F5F5F5"
                               Padding="12"
                               HorizontalOptions="Start"
                               MaximumWidthRequest="300"
                               CornerRadius="18"
                               BorderColor="#E0E0E0">
                            <VerticalStackLayout Spacing="4">
                                <!-- Ð˜Ð¼Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ -->
                                <Label Text="{Binding SenderName}"
                                       FontSize="12"
                                       TextColor="#2E86AB"
                                       FontAttributes="Bold" />

                                <!-- Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                                <Label Text="{Binding MessageText}"
                                       TextColor="#333333"
                                       FontSize="14"
                                       LineBreakMode="WordWrap" />

                                <!-- Ð’Ñ€ÐµÐ¼Ñ -->
                                <Label Text="{Binding SentDate, StringFormat='{0:HH:mm}'}"
                                       FontSize="10"
                                       TextColor="#888888"
                                       HorizontalOptions="End" />
                            </VerticalStackLayout>
                        </Frame>

                        <!-- ÐœÐ¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ -->
                        <Frame Grid.Column="1"
                               IsVisible="{Binding IsMyMessage}"
                               BackgroundColor="#2E86AB"
                               Padding="12"
                               HorizontalOptions="End"
                               MaximumWidthRequest="300"
                               CornerRadius="18">
                            <VerticalStackLayout Spacing="4">
                                <!-- Ð¢ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
                                <Label Text="{Binding MessageText}"
                                       TextColor="White"
                                       FontSize="14"
                                       LineBreakMode="WordWrap" />

                                <!-- Ð’Ñ€ÐµÐ¼Ñ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ -->
                                <HorizontalStackLayout HorizontalOptions="End" Spacing="4">
                                    <Label Text="{Binding SentDate, StringFormat='{0:HH:mm}'}"
                                           FontSize="10"
                                           TextColor="#CCCCCC" />
                                    <Label Text="âœ“âœ“"
                                           FontSize="10"
                                           TextColor="#CCCCCC"
                                           IsVisible="{Binding IsDelivered}" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ -->
        <Border Grid.Row="2"
                BackgroundColor="White"
                Stroke="#E0E0E0"
                StrokeThickness="1"
                Padding="10">
            <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="10">
                <Entry Grid.Column="0"
                       x:Name="MessageEntry"
                       Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..."
                       Completed="OnMessageSent"
                       ReturnType="Send" />

                <Button Grid.Column="1"
                        Text="ðŸ“Ž"
                        BackgroundColor="Transparent"
                        TextColor="#2E86AB"
                        WidthRequest="40"
                        HeightRequest="40"
                        Clicked="OnAttachFileClicked" />

                <Button Grid.Column="2"
                        Text="âž¤"
                        BackgroundColor="#2E86AB"
                        TextColor="White"
                        WidthRequest="40"
                        HeightRequest="40"
                        Clicked="OnSendMessageClicked" />
            </Grid>
        </Border>
    </Grid>
</ContentPage>
